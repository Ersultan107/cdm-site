<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AEC PORTAL | –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/50/2563eb/bolt.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        
        .glass-blur { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .active-nav-btn { background: #2563eb !important; color: white !important; transform: scale(1.05); box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4); }
        
        /* –ü–ª–∞–≤–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è */
        .vote-bar { transition: width 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        
        /* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è –Ω–æ—É—Ç–∞ */
        @media (min-width: 1024px) {
            .main-container { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; }
            .desktop-nav { display: block !important; }
            .mobile-nav { display: none !important; }
        }
    </style>
</head>
<body class="bg-[#fcfdfe] dark:bg-[#020617] text-slate-900 dark:text-white min-h-screen">

    <div id="auth-screen" class="fixed inset-0 z-[200] bg-[#020617] flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center">
            <div class="w-24 h-24 bg-blue-600 rounded-[32px] mx-auto mb-10 flex items-center justify-center shadow-2xl shadow-blue-500/20 rotate-3">
                <i class="fas fa-bolt text-4xl text-white"></i>
            </div>
            <h1 class="text-white text-4xl font-black mb-2 italic uppercase tracking-tighter">AEC PORTAL</h1>
            <p class="text-blue-500 font-bold text-xs mb-10 tracking-widest uppercase">Student Community</p>
            <div class="space-y-4">
                <input type="text" id="user-name" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è" class="w-full p-5 rounded-3xl bg-white/5 border border-white/10 text-white outline-none text-center font-bold focus:border-blue-500 transition-all">
                <input type="text" id="user-group" placeholder="–ì—Ä—É–ø–ø–∞" class="w-full p-5 rounded-3xl bg-white/5 border border-white/10 text-white outline-none text-center font-bold uppercase focus:border-blue-500 transition-all">
                <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-5 rounded-3xl font-black text-lg transition-all active:scale-95 shadow-xl shadow-blue-600/20">–ù–ê–ß–ê–¢–¨</button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden opacity-0 transition-opacity duration-700">
        <header class="fixed top-0 left-0 right-0 z-50 glass-blur bg-white/70 dark:bg-slate-950/80 border-b border-slate-200/50 dark:border-slate-800/50 px-6 py-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-blue-600 text-white rounded-2xl flex items-center justify-center font-black italic shadow-lg">A</div>
                    <div class="hidden sm:block">
                        <h2 id="display-name" class="font-extrabold text-sm italic leading-none">...</h2>
                        <span id="display-group" class="text-[10px] font-black text-blue-600 uppercase tracking-widest">...</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleDark()" class="w-11 h-11 rounded-2xl bg-slate-100 dark:bg-slate-900 flex items-center justify-center border border-slate-200 dark:border-slate-800">
                        <i id="theme-icon" class="fas fa-moon text-slate-600 dark:text-slate-400"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="pt-28 pb-32 px-6 max-w-7xl mx-auto">
            <div class="lg:flex lg:gap-8">
                
                <aside class="hidden lg:block w-72 space-y-4 shrink-0">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-[35px] border border-slate-100 dark:border-slate-800 shadow-sm sticky top-28">
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-6 tracking-widest">–ù–∞–≤–∏–≥–∞—Ü–∏—è</p>
                        <nav class="space-y-2">
                            <button onclick="switchTab('voice')" class="nav-link-btn w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                                <i class="fas fa-comment-dots text-blue-600"></i> –ì–æ–ª–æ—Å –ê–≠–ö
                            </button>
                            <button onclick="switchTab('quests')" class="nav-link-btn w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                                <i class="fas fa-tasks text-blue-600"></i> –ó–∞–¥–∞–Ω–∏—è
                            </button>
                            <button onclick="switchTab('rating')" class="nav-link-btn w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                                <i class="fas fa-trophy text-blue-600"></i> –†–µ–π—Ç–∏–Ω–≥
                            </button>
                            <button onclick="switchTab('team')" class="nav-link-btn w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                                <i class="fas fa-users text-blue-600"></i> –ö–æ–º–∞–Ω–¥–∞ –ö–î–ú
                            </button>
                        </nav>
                    </div>
                </aside>

                <div class="flex-1 max-w-3xl mx-auto lg:mx-0">
                    
                    <section id="tab-voice" class="tab-content active space-y-6">
                        <div class="bg-white dark:bg-slate-900 p-8 rounded-[40px] shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden relative">
                            <div class="absolute top-0 right-0 p-8 opacity-5">
                                <i class="fas fa-quote-right text-6xl"></i>
                            </div>
                            <h3 id="poll-question" class="text-2xl font-black mb-8 italic text-slate-800 dark:text-white uppercase leading-tight">–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ä–æ—Å...</h3>
                            <div id="poll-options" class="grid gap-4"></div>
                        </div>
                        
                        <div class="flex items-center gap-4 px-2">
                            <div class="h-px bg-slate-200 dark:border-slate-800 flex-1"></div>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">–û–±—Å—É–∂–¥–µ–Ω–∏–µ</span>
                            <div class="h-px bg-slate-200 dark:border-slate-800 flex-1"></div>
                        </div>

                        <div id="comments-list" class="space-y-4"></div>
                        
                        <div class="sticky bottom-24 lg:bottom-10 z-10">
                            <div class="relative group">
                                <input type="text" id="comment-input" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ–µ –º–Ω–µ–Ω–∏–µ..." class="w-full p-6 rounded-[30px] bg-white dark:bg-slate-900 shadow-2xl border border-slate-100 dark:border-slate-800 outline-none font-medium pr-16 transition-all focus:ring-2 ring-blue-500/20">
                                <button onclick="sendComment()" class="absolute right-3 top-3 bottom-3 w-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center hover:bg-blue-700 active:scale-90 transition-all">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </section>

                    <section id="tab-quests" class="tab-content">
                        <div class="flex items-center justify-between mb-8 px-2">
                            <h3 class="font-black text-2xl italic uppercase tracking-tighter">–ö–≤–µ—Å—Ç—ã</h3>
                            <span class="bg-blue-100 dark:bg-blue-500/10 text-blue-600 px-4 py-2 rounded-full text-[10px] font-black uppercase">–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</span>
                        </div>
                        <div id="quests-list" class="grid gap-4"></div>
                    </section>

                    <section id="tab-rating" class="tab-content">
                        <h3 class="text-center font-black text-2xl mb-10 italic uppercase tracking-tighter">–õ–∏–¥–µ—Ä—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                        <div id="leaderboard" class="space-y-3 max-w-md mx-auto"></div>
                    </section>

                    <section id="tab-team" class="tab-content">
                        <h3 class="font-black text-2xl mb-8 px-2 italic uppercase">–ö–æ–º–∞–Ω–¥–∞ –ö–î–ú</h3>
                        <div id="team-list" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
                    </section>

                </div>
            </div>
        </main>

        <nav class="mobile-nav fixed bottom-8 left-1/2 -translate-x-1/2 z-50 w-[92%] max-w-md">
            <div class="bg-white/90 dark:bg-slate-950/90 glass-blur p-2 rounded-[30px] border border-slate-200 dark:border-slate-800 shadow-2xl flex justify-around items-center">
                <button onclick="switchTab('voice')" id="nav-voice" class="nav-btn-mob w-14 h-14 rounded-2xl flex items-center justify-center text-slate-400 transition-all"><i class="fas fa-comment-dots text-xl"></i></button>
                <button onclick="switchTab('quests')" id="nav-quests" class="nav-btn-mob w-14 h-14 rounded-2xl flex items-center justify-center text-slate-400 transition-all"><i class="fas fa-bolt text-xl"></i></button>
                <button onclick="switchTab('rating')" id="nav-rating" class="nav-btn-mob w-14 h-14 rounded-2xl flex items-center justify-center text-slate-400 transition-all"><i class="fas fa-trophy text-xl"></i></button>
                <button onclick="switchTab('team')" id="nav-team" class="nav-btn-mob w-14 h-14 rounded-2xl flex items-center justify-center text-slate-400 transition-all"><i class="fas fa-users text-xl"></i></button>
            </div>
        </nav>
    </div>

    <div id="quest-modal" class="fixed inset-0 z-[300] bg-slate-950/95 hidden flex items-center justify-center p-6 glass-blur">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[45px] p-10 shadow-2xl relative overflow-hidden">
            <div class="relative z-10">
                <h3 id="modal-title" class="text-2xl font-black mb-2 uppercase italic text-blue-600">–û–¢–ß–ï–¢</h3>
                <p class="text-[10px] opacity-40 mb-8 font-black uppercase tracking-widest italic leading-relaxed">–ü—Ä–∏–∫—Ä–µ–ø–∏ —Ñ–æ—Ç–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É—á–∞—Å—Ç–∏—è</p>
                <input type="file" id="quest-file" accept="image/*" class="hidden">
                <button onclick="document.getElementById('quest-file').click()" class="w-full py-8 mb-6 border-2 border-dashed border-blue-200 dark:border-slate-800 rounded-[35px] text-blue-600 font-black text-xs flex flex-col items-center gap-3 transition-all hover:bg-blue-50 dark:hover:bg-blue-500/5">
                    <i class="fas fa-camera text-3xl"></i> –í–´–ë–†–ê–¢–¨ –§–û–¢–û
                </button>
                <span id="file-name" class="block text-[10px] text-center mb-8 opacity-50 truncate font-black uppercase">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                <textarea id="quest-text" placeholder="–¢–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="w-full p-6 rounded-3xl bg-slate-50 dark:bg-slate-800 border-none outline-none text-sm mb-8 h-28 resize-none font-medium"></textarea>
                <div class="flex gap-4">
                    <button onclick="closeModal()" class="flex-1 py-5 bg-slate-100 dark:bg-slate-800 rounded-2xl font-black text-[10px] uppercase">–û–¢–ú–ï–ù–ê</button>
                    <button onclick="submitQuest()" id="submit-btn" class="flex-1 py-5 bg-blue-600 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-blue-600/30">–û–¢–ü–†–ê–í–ò–¢–¨</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1BEi1MzL4-2vTVGa_2yyYnVkkDcSch6GIZKeWUHRYFxY';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwmoYuBHSTRAV5QgNU3Aly80OW4KyNIdQ-09e3ZHQ8BbFcxwrDlZbYbSiz2X1gLI28/exec';
        const IMGBB_KEY = 'eee364603c1409aac1e5c593b73c2c7f';
        const GIDS = { team: '0', polls: '1044546960', comments: '194206114' };
        
        let currentQuest = "";

        function handleLogin() {
            const u = document.getElementById('user-name').value;
            const g = document.getElementById('user-group').value.toUpperCase();
            if(u.length > 2) { localStorage.setItem('aec_u', u); localStorage.setItem('aec_g', g); showApp(); }
        }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            setTimeout(() => document.getElementById('main-app').style.opacity = '1', 50);
            document.getElementById('display-name').innerText = localStorage.getItem('aec_u');
            document.getElementById('display-group').innerText = localStorage.getItem('aec_g');
            switchTab(localStorage.getItem('aec_tab') || 'voice');
            loadAllData();
        }

        async function loadAllData() { loadPolls(); loadComments(); loadSheetData(); }

        // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó –¢–ê–ë–õ–ò–¶–´
        async function loadSheetData() {
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GIDS.team}&t=${Date.now()}`);
                const text = await res.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const rows = json.table.rows;

                // –ö–≤–µ—Å—Ç—ã (H, I)
                const q = rows.slice(2).filter(r => r.c[7]?.v);
                document.getElementById('quests-list').innerHTML = q.length ? q.map(r => `
                    <div class="bg-white dark:bg-slate-900 p-8 rounded-[40px] border border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-6">
                            <span class="font-black text-lg uppercase italic pr-4">${r.c[7].v}</span>
                            <span class="bg-blue-600 text-white px-4 py-1.5 rounded-xl font-black text-[10px] shrink-0">+${r.c[8]?.v || 0} –ë–û–ù–£–°–û–í</span>
                        </div>
                        <button onclick="openQuestModal('${r.c[7].v}')" class="w-full py-4 bg-slate-900 dark:bg-blue-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:opacity-90 transition-all">–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢</button>
                    </div>`).join('') : '<div class="text-center py-20 opacity-20 font-black uppercase italic tracking-widest text-sm">–ù–æ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç...</div>';

                // –†–µ–π—Ç–∏–Ω–≥ (E, F)
                const rat = rows.slice(2).filter(r => r.c[4]?.v).map(r => ({n:r.c[4].v, s:r.c[5]?.v||0})).sort((a,b)=>b.s-a.s);
                document.getElementById('leaderboard').innerHTML = rat.map((p,i)=>`
                    <div class="flex justify-between p-6 bg-white dark:bg-slate-900 rounded-[30px] border border-slate-50 dark:border-slate-800 shadow-sm items-center">
                        <div class="flex items-center gap-5">
                            <span class="font-black text-blue-600 italic text-lg">${i+1}</span>
                            <span class="font-bold text-sm uppercase italic tracking-tighter">${p.n}</span>
                        </div>
                        <div class="flex items-center gap-2">
                             <span class="text-[10px] font-black opacity-30 uppercase">Score</span>
                             <span class="bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-xl font-black text-[11px]">${p.s}</span>
                        </div>
                    </div>`).join('');

                // –ö–æ–º–∞–Ω–¥–∞ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ç–æ)
                document.getElementById('team-list').innerHTML = rows.slice(2).filter(r => r.c[0]?.v).map(r => {
                    const name = r.c[0].v;
                    const role = r.c[1]?.v || '–£—á–∞—Å—Ç–Ω–∏–∫';
                    const photo = r.c[3]?.v || ''; // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ –≤ –∫–æ–ª–æ–Ω–∫–µ D
                    const link = r.c[6]?.v || '#';
                    
                    return `
                    <div class="bg-white dark:bg-slate-900 p-8 rounded-[45px] text-center border border-slate-100 dark:border-slate-800 shadow-sm group">
                        <div class="relative w-28 h-28 mx-auto mb-6">
                            <div class="absolute inset-0 bg-blue-600 rounded-full blur-2xl opacity-0 group-hover:opacity-20 transition-all"></div>
                            ${photo ? 
                                `<img src="${photo}" class="w-full h-full rounded-full object-cover border-4 border-white dark:border-slate-800 shadow-xl relative z-10" onerror="this.src='https://ui-avatars.com/api/?name=${name}&background=2563eb&color=fff&size=200'">` : 
                                `<div class="w-full h-full rounded-full bg-blue-600 flex items-center justify-center text-white text-3xl font-black italic relative z-10">${name[0]}</div>`
                            }
                        </div>
                        <h4 class="font-black text-lg mb-1 uppercase italic tracking-tighter">${name}</h4>
                        <p class="text-[10px] text-blue-600 font-black uppercase mb-6 tracking-widest opacity-60">${role}</p>
                        <a href="${link}" target="_blank" class="block w-full py-4 bg-slate-50 dark:bg-slate-800 rounded-2xl font-black text-[10px] uppercase hover:bg-blue-600 hover:text-white transition-all">–ù–∞–ø–∏—Å–∞—Ç—å</a>
                    </div>`;
                }).join('');
            } catch(e) { console.error(e); }
        }

        // –û–ü–†–û–°–´ –° –ü–†–û–¶–ï–ù–¢–ê–ú–ò
        async function loadPolls() {
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GIDS.polls}&t=${Date.now()}`);
                const text = await res.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const poll = json.table.rows.find(r => r.c[3]?.v === 'active');
                
                if(poll) {
                    document.getElementById('poll-question').innerText = poll.c[0].v;
                    const options = [
                        {text: poll.c[1]?.v, votes: poll.c[4]?.v || 0},
                        {text: poll.c[2]?.v, votes: poll.c[5]?.v || 0},
                        {text: poll.c[6]?.v, votes: poll.c[9]?.v || 0},
                        {text: poll.c[7]?.v, votes: poll.c[10]?.v || 0}
                    ].filter(o => o.text);
                    
                    const total = options.reduce((sum, o) => sum + o.votes, 0);
                    
                    document.getElementById('poll-options').innerHTML = options.map((o, i) => {
                        const percent = total > 0 ? Math.round((o.votes / total) * 100) : 0;
                        return `
                        <button onclick="vote(${i+1})" class="relative w-full p-5 rounded-2xl border border-slate-100 dark:border-slate-800 text-left overflow-hidden group active:scale-[0.98] transition-all">
                            <div class="vote-bar absolute left-0 top-0 bottom-0 bg-blue-600/10 dark:bg-blue-600/20" style="width: ${percent}%"></div>
                            <div class="relative flex justify-between items-center font-bold text-xs uppercase italic">
                                <span>${o.text}</span>
                                <span class="text-blue-600 font-black">${percent}%</span>
                            </div>
                        </button>`;
                    }).join('');
                }
            } catch(e) {}
        }

        async function vote(o) {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: "vote", option: o }) });
            loadPolls(); // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        }

        // –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò
        async function loadComments() {
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GIDS.comments}&t=${Date.now()}`);
                const text = await res.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                document.getElementById('comments-list').innerHTML = json.table.rows.slice(1).reverse().map(r => `
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-[30px] shadow-sm border border-slate-50 dark:border-slate-800">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-blue-600 font-black text-[9px] uppercase tracking-tighter">${r.c[1]?.v} ‚Ä¢ ${r.c[2]?.v}</span>
                        </div>
                        <p class="text-sm font-semibold leading-relaxed">${r.c[3]?.v}</p>
                    </div>`).join('');
            } catch(e) {}
        }

        async function sendComment() {
            const i = document.getElementById('comment-input'); if(!i.value.trim()) return;
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: "comment", name: localStorage.getItem('aec_u'), group: localStorage.getItem('aec_g'), text: i.value }) });
            i.value = ''; loadComments();
        }

        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        function openQuestModal(q) { currentQuest = q; document.getElementById('modal-title').innerText = q; document.getElementById('quest-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('quest-modal').classList.add('hidden'); }
        document.getElementById('quest-file').onchange = function() { document.getElementById('file-name').innerText = this.files[0]?.name || "–§–∞–π–ª –≥–æ—Ç–æ–≤"; };

        async function submitQuest() {
            const btn = document.getElementById('submit-btn');
            const file = document.getElementById('quest-file').files[0];
            if(!file) return alert("–î–æ–±–∞–≤—å —Ñ–æ—Ç–æ!");
            btn.disabled = true; btn.innerText = "–û–¢–ü–†–ê–í–ö–ê...";
            const fd = new FormData(); fd.append("image", file);
            try {
                const imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                const imgData = await imgRes.json();
                if(imgData.success) {
                    const payload = { type: "quest_report", name: localStorage.getItem('aec_u'), group: localStorage.getItem('aec_g'), quest: currentQuest, proof: imgData.data.url, comment: document.getElementById('quest-text').value };
                    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                    alert("–û–¢–ß–ï–¢ –ü–†–ò–ù–Ø–¢! üî•"); closeModal();
                }
            } catch(e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"); }
            btn.disabled = false; btn.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨";
        }

        function switchTab(id) {
            localStorage.setItem('aec_tab', id);
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn-mob, .nav-link-btn').forEach(b => b.classList.remove('active-nav-btn', 'text-blue-600', 'bg-blue-50', 'dark:bg-slate-800'));
            
            document.getElementById('tab-'+id).classList.add('active');
            const mobBtn = document.getElementById('nav-'+id);
            if(mobBtn) mobBtn.classList.add('active-nav-btn');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleDark() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        window.onload = () => { if(localStorage.getItem('aec_u')) showApp(); };
    </script>
</body>
</html>
